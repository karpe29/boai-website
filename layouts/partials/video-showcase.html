<section class="relative min-h-screen bg-primary py-16">
    <!-- Background gradient overlay -->
    <div class="absolute inset-0 bg-gradient-to-br from-primary via-primary-dark to-primary opacity-90"></div>
    
    <div class="container mx-auto px-6 relative z-10">
        <div class="max-w-7xl mx-auto">
            <!-- Title Section -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4" style="font-family: 'Georgia', 'Times New Roman', 'Palatino', 'Book Antiqua', serif;">
                    Video Showcase
                </h1>
                <p class="text-lg md:text-xl text-[#d8d8dc]/80 font-light max-w-3xl mx-auto" style="font-family: 'Poppins', sans-serif;">
                    Explore our collection of personalized video ads
                </p>
            </div>
            
            <!-- Category Filter -->
            <div class="video-category-filter mb-8 flex flex-wrap justify-center gap-3">
                <button class="category-filter-btn active" data-category="all">
                    All Videos
                </button>
                <!-- Category buttons will be dynamically generated -->
            </div>
            
            <!-- Mosaic Grid Container -->
            <div id="video-mosaic-grid" class="video-mosaic-container">
                <!-- Videos will be dynamically inserted here -->
            </div>
        </div>
    </div>
</section>

<!-- Video Lightbox Modal -->
<div id="video-lightbox" class="video-lightbox" style="display: none;">
    <div class="video-lightbox-overlay"></div>
    <div class="video-lightbox-content">
        <button class="video-lightbox-close" aria-label="Close video">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div class="video-lightbox-player">
            <video id="lightbox-video" class="w-full h-full" controls autoplay>
                <source id="lightbox-video-source" src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        <div class="video-lightbox-title">
            <p id="lightbox-video-title" class="text-white text-lg font-medium"></p>
        </div>
    </div>
</div>

<script>
// Global state
let allVideos = [];
let currentCategory = 'all';

document.addEventListener('DOMContentLoaded', function() {
    // Get category from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const categoryFromUrl = urlParams.get('category');
    if (categoryFromUrl) {
        currentCategory = categoryFromUrl;
    }
    
    // Initialize videos and grid (filters will be set up inside setupVideoGrid)
    setupVideoGrid();
    
    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            // Reload layout on resize
            setupVideoGrid();
        }, 250);
    });
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
        const urlParams = new URLSearchParams(window.location.search);
        const categoryFromUrl = urlParams.get('category') || 'all';
        if (categoryFromUrl !== currentCategory) {
            currentCategory = categoryFromUrl;
            setupCategoryFilters();
            setupVideoGrid();
        }
    });
});

function setupCategoryFilters() {
    const filterContainer = document.querySelector('.video-category-filter');
    if (!filterContainer || allVideos.length === 0) return;
    
    // Get all unique categories from videos
    const categories = ['all', ...new Set(allVideos.map(v => v.category).filter(Boolean))];
    
    // Only regenerate if categories have changed or buttons don't exist
    const existingButtons = filterContainer.querySelectorAll('.category-filter-btn');
    if (existingButtons.length === 0 || existingButtons.length !== categories.length) {
        // Generate filter buttons
        let filterHTML = '';
        categories.forEach(category => {
            const displayName = category === 'all' ? 'All Videos' : category.charAt(0).toUpperCase() + category.slice(1);
            const isActive = category === currentCategory ? 'active' : '';
            filterHTML += `
                <button class="category-filter-btn ${isActive}" data-category="${category}">
                    ${displayName}
                </button>
            `;
        });
        
        filterContainer.innerHTML = filterHTML;
        
        // Add click handlers
        filterContainer.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                setCategory(category);
            });
        });
    } else {
        // Just update active state
        filterContainer.querySelectorAll('.category-filter-btn').forEach(btn => {
            const btnCategory = btn.getAttribute('data-category');
            if (btnCategory === currentCategory) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
}

function setCategory(category) {
    currentCategory = category;
    
    // Update URL without page reload
    const url = new URL(window.location);
    if (category === 'all') {
        url.searchParams.delete('category');
    } else {
        url.searchParams.set('category', category);
    }
    window.history.pushState({ category }, '', url);
    
    // Update active button
    document.querySelectorAll('.category-filter-btn').forEach(btn => {
        if (btn.getAttribute('data-category') === category) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Reload grid with filtered videos (don't call setupCategoryFilters again)
    createMosaicGrid();
}

function setupVideoGrid() {
    createMosaicGrid();
    // Setup filters after videos are initialized
    if (allVideos.length > 0) {
        setupCategoryFilters();
    }
}

function createMosaicGrid() {
    // ============================================
    // CONFIGURATION: Change this to adjust row height
    // ============================================
    const TARGET_ROW_HEIGHT = 350; // Change this value to set all row heights
    // ============================================
    
    const container = document.getElementById('video-mosaic-grid');
    
    // Initialize all videos with categories (only on first load)
    if (allVideos.length === 0) {
        allVideos = [
            { src: "{{ "videos/portfolio1.mp4" | relURL }}", title: "Portfolio Video 1", category: "portfolio" },
            { src: "{{ "videos/portfolio2.mp4" | relURL }}", title: "Portfolio Video 2", category: "portfolio" },
            { src: "{{ "videos/demoVideo.mp4" | relURL }}", title: "Demo Video", category: "demo" },
            { src: "{{ "videos/portfolio1.mp4" | relURL }}", title: "Portfolio Video 1", category: "portfolio" },
            { src: "{{ "videos/portfolio2.mp4" | relURL }}", title: "Portfolio Video 2", category: "portfolio" },
            { src: "{{ "videos/demoVideo.mp4" | relURL }}", title: "Demo Video", category: "demo" },
            { src: "{{ "videos/portfolio1.mp4" | relURL }}", title: "Portfolio Video 1", category: "portfolio" },
            { src: "{{ "videos/portfolio2.mp4" | relURL }}", title: "Portfolio Video 2", category: "portfolio" },
            { src: "{{ "videos/demoVideo.mp4" | relURL }}", title: "Demo Video", category: "demo" }
        ];
    }
    
    // Filter videos based on current category
    const videos = currentCategory === 'all' 
        ? allVideos 
        : allVideos.filter(video => video.category === currentCategory);
    
    const gap = 20;
    const containerPadding = 10;
    
    // Get container width
    function getContainerWidth() {
        const computedStyle = window.getComputedStyle(container);
        const padding = parseFloat(computedStyle.paddingLeft) + parseFloat(computedStyle.paddingRight);
        return container.offsetWidth - padding || container.parentElement.offsetWidth - 48;
    }
    
    const containerWidth = getContainerWidth();
    const availableWidth = containerWidth - (containerPadding * 2);
    
    // Aspect ratios for mosaic effect
    const aspectRatios = [16/9, 4/3, 1/1, 3/4, 9/16, 21/9, 16/9, 4/3, 1/1];
    
    // Calculate layout using justified layout algorithm
    const boxes = [];
    let currentRow = [];
    let currentRowWidth = 0;
    let currentTop = containerPadding;
    
    videos.forEach((video, index) => {
        const aspectRatio = aspectRatios[index % aspectRatios.length];
        const boxHeight = TARGET_ROW_HEIGHT; // Use fixed row height
        const boxWidth = boxHeight * aspectRatio;
        
        // Check if this box fits in current row
        const neededWidth = boxWidth + (currentRow.length > 0 ? gap : 0);
        
        if (currentRowWidth + neededWidth <= availableWidth || currentRow.length === 0) {
            // Add to current row
            currentRow.push({ width: boxWidth, height: boxHeight, video: video, aspectRatio: aspectRatio });
            currentRowWidth += neededWidth;
        } else {
            // Finalize current row and start new one
            if (currentRow.length > 0) {
                // Scale only widths to fit container, keep height fixed
                const denominator = currentRowWidth - (gap * (currentRow.length - 1));
                const scale = denominator > 0 ? (availableWidth - (gap * (currentRow.length - 1))) / denominator : 1;
                // Keep row height fixed at TARGET_ROW_HEIGHT
                const fixedRowHeight = TARGET_ROW_HEIGHT;
                
                let left = containerPadding;
                currentRow.forEach(box => {
                    const scaledWidth = box.width * scale;
                    boxes.push({
                        left: left,
                        top: currentTop,
                        width: scaledWidth,
                        height: fixedRowHeight, // Always use fixed height
                        video: box.video
                    });
                    left += scaledWidth + gap;
                });
                
                currentTop += fixedRowHeight + gap; // Use fixed height for spacing
            }
            
            // Start new row
            currentRow = [{ width: boxWidth, height: boxHeight, video: video, aspectRatio: aspectRatio }];
            currentRowWidth = boxWidth;
        }
    });
    
    // Finalize last row
    if (currentRow.length > 0) {
        // Scale only widths to fit container, keep height fixed
        const denominator = currentRowWidth - (gap * (currentRow.length - 1));
        const scale = denominator > 0 ? (availableWidth - (gap * (currentRow.length - 1))) / denominator : 1;
        // Keep row height fixed at TARGET_ROW_HEIGHT
        const fixedRowHeight = TARGET_ROW_HEIGHT;
        
        let left = containerPadding;
        currentRow.forEach(box => {
            const scaledWidth = box.width * scale;
            boxes.push({
                left: left,
                top: currentTop,
                width: scaledWidth,
                height: fixedRowHeight, // Always use fixed height
                video: box.video
            });
            left += scaledWidth + gap;
        });
        
        currentTop += fixedRowHeight; // Use fixed height
    }
    
    // Create HTML
    let html = '';
    boxes.forEach((box, index) => {
        html += `
            <div class="video-mosaic-item" 
                 data-video-src="${box.video.src}"
                 data-video-title="${box.video.title}"
                 style="position: absolute; 
                        left: ${box.left}px; 
                        top: ${box.top}px; 
                        width: ${box.width}px; 
                        height: ${box.height}px;
                        border-radius: 12px;
                        overflow: hidden;
                        cursor: pointer;
                        transition: transform 0.3s ease, box-shadow 0.3s ease;">
                <div class="relative w-full h-full bg-primary-dark group">
                    <video 
                        class="w-full h-full object-cover"
                        preload="none"
                        loading="lazy"
                        muted
                        playsinline
                        data-src="${box.video.src}">
                        <source data-src="${box.video.src}" type="video/mp4">
                    </video>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                        <p class="text-white text-sm font-medium">${box.video.title}</p>
                    </div>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="bg-white/20 backdrop-blur-md rounded-full p-4">
                            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.style.height = `${currentTop + containerPadding}px`;
    container.style.position = 'relative';
    
    // Setup lazy loading and hover effects
    setupVideoInteractions(container);
}


function setupVideoInteractions(container) {
    // Lazy load videos using Intersection Observer
    const videoElements = container.querySelectorAll('video[data-src]');
    const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                const source = video.querySelector('source');
                if (source && source.dataset.src) {
                    source.src = source.dataset.src;
                    video.load();
                    video.addEventListener('loadeddata', () => {
                        video.classList.add('loaded');
                        const item = video.closest('.video-mosaic-item');
                        if (item) {
                            item.style.setProperty('--loading', 'none');
                        }
                    }, { once: true });
                    videoObserver.unobserve(video);
                }
            }
        });
    }, {
        rootMargin: '50px'
    });
    
    videoElements.forEach(video => {
        videoObserver.observe(video);
    });
    
    // Add hover effects
    const items = container.querySelectorAll('.video-mosaic-item');
    items.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.zIndex = '10';
            this.style.boxShadow = '0 20px 40px rgba(255, 127, 39, 0.3)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.zIndex = '1';
            this.style.boxShadow = 'none';
        });
        
        const video = item.querySelector('video');
        if (video) {
            item.addEventListener('mouseenter', () => {
                video.play().catch(e => console.log('Autoplay prevented'));
            });
            item.addEventListener('mouseleave', () => {
                video.pause();
            });
            
            // Add click handler to open lightbox
            item.addEventListener('click', () => {
                const videoSrc = item.getAttribute('data-video-src');
                const videoTitle = item.getAttribute('data-video-title');
                openVideoLightbox(videoSrc, videoTitle);
            });
        }
    });
}

function openVideoLightbox(videoSrc, videoTitle) {
    const lightbox = document.getElementById('video-lightbox');
    const lightboxVideo = document.getElementById('lightbox-video');
    const lightboxVideoSource = document.getElementById('lightbox-video-source');
    const lightboxVideoTitle = document.getElementById('lightbox-video-title');
    
    if (!lightbox || !lightboxVideo || !lightboxVideoSource) return;
    
    // Set video source and title
    lightboxVideoSource.src = videoSrc;
    lightboxVideo.load();
    lightboxVideoTitle.textContent = videoTitle || 'Video';
    
    // Show lightbox
    lightbox.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
    
    // Play video with sound (unmuted)
    setTimeout(() => {
        lightboxVideo.muted = false;
        lightboxVideo.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
        });
    }, 100);
}

function closeVideoLightbox() {
    const lightbox = document.getElementById('video-lightbox');
    const lightboxVideo = document.getElementById('lightbox-video');
    
    if (!lightbox || !lightboxVideo) return;
    
    // Pause and reset video
    lightboxVideo.pause();
    lightboxVideo.currentTime = 0;
    lightboxVideo.muted = true; // Reset to muted
    
    // Hide lightbox
    lightbox.style.display = 'none';
    document.body.style.overflow = ''; // Restore scrolling
}

// Initialize lightbox event listeners
document.addEventListener('DOMContentLoaded', function() {
    const lightbox = document.getElementById('video-lightbox');
    const closeButton = document.querySelector('.video-lightbox-close');
    const overlay = document.querySelector('.video-lightbox-overlay');
    
    if (closeButton) {
        closeButton.addEventListener('click', closeVideoLightbox);
    }
    
    if (overlay) {
        overlay.addEventListener('click', closeVideoLightbox);
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && lightbox && lightbox.style.display === 'block') {
            closeVideoLightbox();
        }
    });
});
</script>

<style>
/* Category Filter Styles */
.video-category-filter {
    margin-bottom: 2rem;
}

.category-filter-btn {
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
    white-space: nowrap;
}

.category-filter-btn:hover {
    background: rgba(255, 127, 39, 0.3);
    border-color: rgba(255, 127, 39, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 127, 39, 0.2);
}

.category-filter-btn.active {
    background: rgba(255, 127, 39, 0.8);
    border-color: rgba(255, 127, 39, 1);
    color: white;
    box-shadow: 0 4px 16px rgba(255, 127, 39, 0.4);
}

.category-filter-btn.active:hover {
    background: rgba(255, 127, 39, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 127, 39, 0.5);
}

@media (max-width: 768px) {
    .category-filter-btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
    }
    
    .video-category-filter {
        gap: 0.5rem;
    }
}

.video-mosaic-container {
    position: relative;
    width: 100%;
    min-height: 400px;
}

.video-mosaic-item {
    border: 2px solid rgba(255, 255, 255, 0.1);
    background: #1a1a1a;
}

.video-mosaic-item:hover {
    border-color: rgba(255, 127, 39, 0.5);
}

.video-mosaic-item video {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Loading state */
.video-mosaic-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, #2c2c2c 25%, #3a3a3a 50%, #2c2c2c 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    z-index: 1;
    pointer-events: none;
}

.video-mosaic-item video.loaded ~ *,
.video-mosaic-item:has(video.loaded)::before {
    display: none;
    animation: none;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Video Lightbox Styles */
.video-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.video-lightbox-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
}

.video-lightbox-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
}

.video-lightbox-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10001;
}

.video-lightbox-close:hover {
    background: rgba(255, 127, 39, 0.8);
    border-color: rgba(255, 127, 39, 1);
    transform: scale(1.1);
}

.video-lightbox-player {
    width: 100%;
    background: #1a1a1a;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.video-lightbox-player video {
    width: 100%;
    height: auto;
    display: block;
    max-height: 80vh;
}

.video-lightbox-title {
    margin-top: 20px;
    text-align: center;
    padding: 0 20px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translate(-50%, calc(-50% + 30px));
        opacity: 0;
    }
    to {
        transform: translate(-50%, -50%);
        opacity: 1;
    }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .video-lightbox-content {
        width: 95%;
        max-height: 85vh;
    }
    
    .video-lightbox-close {
        top: -40px;
        width: 36px;
        height: 36px;
    }
    
    .video-lightbox-player video {
        max-height: 70vh;
    }
}

</style>
